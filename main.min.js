!function(){function e(){$("title").innerText="Game Menu",hide([$("game-view"),$("main-menu-btn")]),hide(this),show($("menu-view"));let e=document.querySelectorAll(".low-health");for(let t=0;t<e.length;t++)e[t].classList.remove("low-health");let t=$$(".buffs");for(let e=0;e<t.length;e++)t[e].innerHTML="";$("p1-turn-results").innerHTML="",$("p2-turn-results").innerHTML="",hide($("turn-status-p"))}function t(){if(!q)return;window.getSelection?window.getSelection().removeAllRanges():document.selection&&document.selection.empty();let e=C(q),t="Would you like to give "+q+" a nickname?";if(e&&(t='Would you like to rename your "'+e+'"?'),!confirm(t))return;if(null===(e=prompt("Nickname to give your "+q+" (Leave empty to remove nickname):",e||"")))return;let n="Calling update.php with name="+q,o=new FormData;o.append("name",q),""!=e?(o.append("nickname",e),n+=" and nickname="+e):n+=" and no nickname",console.log(n),postRequest("update.php",o,function(){let t=""!=e?e:q;alert("Success! You have renamed "+t+"!"),r("pokedex-view",pid),r("my-pokemon",pid),r("my-dex-view",pid);let n=q+(""!=e?" ("+e+")":"");$$("#your-pokedex-view-card .name").innerText=n})}function n(){!function(){let e=$$(".opponent-btn");for(let t=0;t<e.length;t++)e[t].onclick=function(){hide([$$("#new-game-view .part-ii"),$$("#new-game-view .part-iii")]),this.classList.toggle("chosen-btn");let t=$$("#new-game-view button");for(let e=0;e<t.length;e++)t[e]!=this&&t[e].classList.remove("chosen-btn");for(let t=0;t<e.length;t++)if(e[t]!=this)if(this.classList.contains("chosen-btn"))e[t].classList.remove("chosen-btn"),"student"!=this.id&&hide($("choose-student")),show($$("#new-game-view .part-ii"));else{hide([$$("#new-game-view .part-ii")]),hide([$$("#new-game-view .part-iii")]);let n=$$("#new-game-view button");for(let e=0;e<n.length;e++)n[e].classList.remove("chosen-btn");show(e[t])}"student"==this.id?(toggleDisplay($("choose-student")),$("choose-student").classList.contains("hidden")||(S="medskm")):S=this.id}}(),$("new-game-btn").onclick=function(){L(this.id,"new-game-view"),$("new-game-view").classList.contains("hidden")||$$("#new-game-view .part-0").classList.remove("hidden")},$("choose-pokemon-btn").onclick=function(){r("pokedex-view",pid),toggleDisplay($$("#new-game-view .part-iii")),this.classList.toggle("chosen-btn")},$("start-game").onclick=function(){""!=q&&(""==S&&(S="-bot-"),$("choose-pokemon-title").innerText="Choose a Pokemon:",show($$("#new-game-view .part-iii hr")),function(e){if(""==q)alert("Please select a Pokemon to start a game with.");else{let t=new FormData;t.append("opponent",e),t.append("mypokemon",q),t.append("pid",pid),t.append("token",token),postRequest(M+"create-game.php",t,function(t){"-bot-"==e||"invite-view"==P().id?y(JSON.parse(t)):(alert("Game invite sent successfully!"),s())})}}(S))}}function o(){S&&"-bot-"!=S&&(hide($$("#new-game-view .part-iii hr")),$("choose-pokemon-title").innerText="Choose a Pokemon to play with "+S+":",r("pokedex-view",pid),show([$$("#new-game-view"),$$("#new-game-view .part-iii")]),hide($("invite-view")))}function i(){const e={37:"left",38:"up",39:"right",40:"down",65:"a",66:"b"},t=["up","up","down","down","left","right","left","right","b","a"];let n=0;document.addEventListener("keydown",function(o){e[o.keyCode]==t[n]?++n==t.length&&(alert("Welcome PonyTA."),function(e,t){var n=1,o=function(){0===--n&&(BrowserPonies.setBaseUrl(t.baseurl),BrowserPoniesBaseConfig.loaded||(BrowserPonies.loadConfig(BrowserPoniesBaseConfig),BrowserPoniesBaseConfig.loaded=!0),BrowserPonies.loadConfig(t),BrowserPonies.running()||BrowserPonies.start())};"undefined"==typeof BrowserPoniesConfig&&(window.BrowserPoniesConfig={}),"undefined"==typeof BrowserPoniesBaseConfig&&(++n,BrowserPoniesConfig.onbasecfg=o),"undefined"==typeof BrowserPonies&&(++n,BrowserPoniesConfig.oninit=o);var i=document.body||document.documentElement||document.getElementsByTagName("head")[0];for(var s in e)if(!document.getElementById(s))if(i){var r=document.createElement("script");r.type="text/javascript",r.id=s,r.src=e[s],i.appendChild(r)}else document.write('<script type="text/javscript" src="'+e[s]+'" id="'+s+'"><\/script>');o()}({"browser-ponies-script":"https://panzi.github.io/Browser-Ponies/browserponies.js","browser-ponies-config":"https://panzi.github.io/Browser-Ponies/basecfg.js"},{baseurl:"https://panzi.github.io/Browser-Ponies/",fadeDuration:500,volume:1,fps:25,speed:3,audioEnabled:!1,dontSpeak:!0,showFps:!1,showLoadProgress:!0,speakProbability:.1,spawn:{"rainbow dash":1}}),document.body.style.background="-webkit-linear-gradient(top, #2d96c6 0%,#c9e6f4 100%)",document.body.style.height="100vh",$("title").innerText="PonyTA MODE ACTIVE!",n=0):n=0})}function s(){getRequest(M+"list-games.php",creds(),f)}function r(e,t){let n=t==pid;getRequest(M+"users.php","?mode=pokemon&pid="+t,function(t){let o=JSON.parse(t);!function(e,t){let n=$(e);!function(e){let t=$(e).querySelectorAll(".sprite");for(let e=0;e<t.length;e++)t[e].classList.add("unfound"),t[e].onclick=""}(e);for(let o=0;o<t.length;o++){let i=n.querySelector("img[pokemon='"+escSpChar(t[o])+"']");i&&(i.classList.remove("unfound"),i.onclick="pokedex-view"==e?k:m)}}(e,o),n&&fetchMyPokemon()})}function a(){let e=M+"list-trades.php";getRequest(e,creds(),p)}function l(e,t){getRequest(M+"trade-info.php",creds()+"&trade_id="+e,function(e){!function(e,t){let n=gen("tr");n.id=e.id;let o="to-you"===t?e.offerer:e.offeree,i=genText("td",o),s=gen("td"),r=genText("p",e.requested_pokemon),a=genText("p",e.offered_pokemon),l=$$("#pokedex-view .sprite[pokemon='"+e.requested_pokemon+"']").cloneNode();s.appendChild(r),r.appendChild(l);let p=gen("td"),d=$$("#pokedex-view .sprite[pokemon='"+e.offered_pokemon+"']").cloneNode();"to-you"===t?l.classList.remove("unfound"):d.classList.remove("unfound");p.appendChild(a),a.appendChild(d);let h=genText("td",e.created),m=gen("td");if(appendChildren(n,[i,p,s,h]),"to-you"==t){let e=gen("button","small-btn");e.innerText="Accept",e.onclick=c;let t=gen("button","small-btn");t.innerText="Reject",t.onclick=u,appendChildren(m,[e,t])}else{let e=gen("button","small-btn");e.innerText="Cancel Request",m.appendChild(e),e.onclick=u}n.appendChild(m),$$("#"+t+" .results-table tbody").appendChild(n)}(JSON.parse(e),t)})}function p(e){let t=JSON.parse(e);0===t.offers_from_me.length&&0===t.offers_to_me.length?($("trade-message").innerHTML="There are no trades currently offered to you.",hide([$("by-you"),$("to-you")]),show($("trade-message"))):function(e){let t=e.offers_to_me;t.length>0?$$("#to-you .results-table").innerHTML="<tr><th>Player</th><th>Their Offer</th><th>Their Request</th><th>Date</th></tr>":$$("#to-you .results-table").innerHTML="<p>You do not have any proposals to accept or decline.</p>";for(let e=0;e<t.length;e++){l(t[e],"to-you")}let n=e.offers_from_me;n.length>0?$$("#by-you .results-table").innerHTML="<tr><th>Player</th><th>Your Offer</th><th>Your Request</th><th>Date</th></tr>":$$("#by-you .results-table").innerHTML="<p>You do not have any proposals waiting to be accepted or declined by other players.</p>";for(let e=0;e<n.length;e++){l(n[e],"by-you")}hide($("trade-message")),show([$("by-you"),$("to-you"),$$("#by-you .results-table"),$$("#to-you .results-table")])}(t)}function d(e){let t=JSON.parse(e),n=$("users");for(let e=0;e<t.length;e++)if(t[e]!=pid){let o=document.createElement("option");o.value=t[e],o.innerText=t[e],n.appendChild(o);let i=document.createElement("option");i.value=t[e],i.innerText=t[e],$("opps").appendChild(i)}$("opps").value="whitab",$("users").value="whitab",$("opps").onchange=function(){S=this.value,show($("choose-pokemon-btn")),show($("start-game"))}}function c(){if(confirm("Are you sure you want to accept this trade?")){let e=this.parentNode.parentNode.id,t=new FormData;t.append("pid",pid),t.append("token",token),t.append("action","accept");let n=this.parentNode.parentNode.querySelectorAll("td")[2].innerText.trim(),o=this.parentNode.parentNode.querySelectorAll("td")[1].innerText.trim();t.append("pokemon",n),t.append("trade_id",e),postRequest(M+"conclude-trade.php",t,function(){alert("Trade successful!"),function(e,t){console.log("Calling student's trade.php with mypokemon="+e+" and theirpokemon="+t+"...");let n=new FormData;n.append("mypokemon",e),n.append("theirpokemon",t),postRequest("trade.php",n,logStudentTestCall)}(n,o);let e="";confirm("You've collected "+o+" from a trade! Give it a nickname?")&&(e=prompt("Nickname to give your "+o+":")),e&&function(e,t){let n=new FormData;n.append("name",e),n.append("nickname",t),console.log("Calling student's update.php with name="+name+" and nickname="+t+"..."),postRequest("update.php",n,logStudentTestCall)}(o,e),a()})}}function u(){if(confirm("Are you sure you want to cancel this trade?")){let e=this.parentNode.parentNode.id,t=new FormData;t.append("pid",pid),t.append("token",token),t.append("pokemon",this.parentNode.parentNode.querySelectorAll("td")[2].innerText.trim()),t.append("tradeid",e),postRequest(M+"cancel-trade.php",t,function(){alert("Trade successfully canceled"),a()})}}function h(){let e=$("offer").innerText,t=$("request").innerText;if(""!=e&&""!=t){let n=new FormData;n.append("pid",pid),n.append("pid2",$("users").value),n.append("token",token),n.append("pokemon",e),n.append("pokemon2",t),postRequest(M+"offer-trade.php",n,function(){alert("Proposal successful!"),$("view-proposals").click()})}else alert("Please select a Pokemon to offer and request from the displayed Pokedex views.")}function m(){this.parentNode.parentNode.querySelector("h2 span")?this.parentNode.parentNode.querySelector("h2 span").innerText=this.getAttribute("pokemon"):(q=this.getAttribute("pokemon"),k.call(this))}function f(e){let t=JSON.parse(e);if(t.offered_by_me||t.offered_to_me||t.in_progress){$("games-table").innerHTML="<tr><th>Other Player</th></tr>",t.offered_by_me&&w("Pending","cancel",t.offered_by_me),t.offered_to_me&&w("Pending","accept",t.offered_to_me),t.in_progress&&w("current","join",t.in_progress)}else $$("#invite-results h3").innerHTML="You currently have no games in progress or pending.";L("invite-btn","invite-view")}function g(e){let t=e.split("\n");for(let e=0;e<t.length;e++){let n=t[e].split(":"),o=n[0],i=n[1],s=gen("img",["sprite","unfound"]);s.src=_+"sprites/"+i,s.setAttribute("pokemon",o),$("my-pokemon").appendChild(s),$("their-pokemon").appendChild(s.cloneNode()),$("pokedex-view").appendChild(s.cloneNode()),$("my-dex-view").appendChild(s.cloneNode())}}function w(e,t,n){for(let e=0;e<n.length;e++){let i=n[e][0],s=n[e][1];s==pid&&(s=n[e][2]),s||(s="-bot-");let r=genText("td",s),a=gen("td"),l=gen("button",["small-btn"]);if("accept"==t)l.innerText="Accept Invite",l.onclick=function(){S=this.parentNode.parentNode.querySelector("td").innerText,hide($("opponent-btns")),hide($("choose-student")),hide($$("#new-game-view .part-ii")),o()},a.appendChild(l);else if("join"==t)l.innerText="Continue Game",a.appendChild(l),l.onclick=function(){!function(e){N=e,getRequest(M+"game-info.php",creds()+"&guid="+e,function(e){y(JSON.parse(e))})}(this.parentNode.parentNode.id)};else if("cancel"==t){let e=genText("span","Invite Pending");a.appendChild(e)}let p=gen("tr");p.id=i,appendChildren(p,[r,a]),$("games-table").appendChild(p)}show($("games-table"))}function y(e){let t=e;console.log(t),t.warning?console.log(t.warning):(!function(e){let t=e.pid1,n=e.pid2,o=t==pid?n:t,i=e.players[pid],s=e.players[o],r=e[i],a=e[s];"-bot-"!=o&&(i==e.turn?$("turn-status").innerText="It's your turn!":$("turn-status").innerText="Waiting for "+o+" to make a move...",show($("turn-status-p")));v("my-card",r),v("their-card",a),b("my-card",r),b("their-card",a)}(t),N=t.guid,$("title").innerText="Pokemon Battle Mode!",function(){let e=$$(".opponent-btn");for(let t=0;t<e.length;t++)e[t].classList.remove("chosen-btn"),e[t].classList.remove("hidden");e=$$(".menu-btn");for(let t=0;t<e.length;t++)e[t].classList.remove("chosen-btn")}(),x(),hide([$("menu-view")]),show([$("game-view"),$("main-menu-btn"),$("results-container")]))}function v(e,t){e="#"+e,$$(e+" .name").innerHTML=t.name,$$(e+" .pokepic").src=_+t.images.photo,$$(e+" .weakness").src=_+t.images.weaknessIcon,$$(e+" .type").src=_+t.images.typeIcon,$$(e+" .info").innerHTML=t.info.description,$$(e+" .hp").innerHTML=t.hp+"HP";let n=t.moves,o=$$(e+" .moves button"),i=0;for(;i<n.length;i++){n[i].name;let t=o[i];t.classList.contains("hidden")&&t.classList.remove("hidden");t.children[0].innerText=n[i].name;t.children[2].src=_+"icons/"+n[i].type+".jpg";let s=t.children[1];n[i].dp?s.innerText=n[i].dp+" DP":s.innerText="","#my-card"===e&&(t.disabled=!1,t.onclick=function(){!function(e){$("p1-turn-results").innerHTML="",$("p2-turn-results").innerHTML="",show($("loading")),e=e.toLowerCase();let t=new FormData;t.append("move",e),t.append("guid",N),t.append("pid",pid),t.append("token",token);let n=new XMLHttpRequest;n.onreadystatechange=function(e){if(4===n.readyState)if(200===n.status)!function(e){let t=e.pid1,n=e.pid2,o=t==pid?n:t,i=e.players[pid],s=e.players[o],r=e[i],a=e[s];"-bot-"!=o?(i==e.turn?$("turn-status").innerText="It's your turn!":$("turn-status").innerText="Waiting for "+o+" to make a move...",show($("turn-status-p"))):o=a.name;b("my-card",r),b("their-card",a);let l=e.results,p=l["p1-result"],d=l["p2-result"],c="p1"==i;if(""!=e.turn){if(d){let t=c?o:"You";"p2"==e.turn?$("p1-turn-results").innerHTML=t+" played "+l["p2-move"]+" and "+d+"!":$("p2-turn-results").innerHTML=t+" played "+l["p2-move"]+" and "+d+"!"}if(p){let t=c?"You":o;"p2"==e.turn?$("p2-turn-results").innerHTML=t+" played "+l["p1-move"]+" and "+p+"!":$("p1-turn-results").innerHTML=t+" played "+l["p1-move"]+" and "+p+"!"}}else{if(0==a["current-hp"]){let e=c?l["p1-move"]:l["p2-move"],t=c?p:d;$("p1-turn-results").innerHTML="You played "+e+" and "+t+"!"}else{let e=c?l["p2-move"]:l["p1-move"],t=c?d:p;$("p1-turn-results").innerHTML=o+" played "+e+" and "+t+"!"}}hide($("loading")),show([$("p1-turn-results"),$("p2-turn-results")])}(JSON.parse(this.responseText));else if(201===n.status){let e=JSON.parse(n.statusText).warning;console.log(e),$("turn-status").innerText="It's not your turn!",show($("turn-status-p")),hide($("loading"))}},n.open("POST",M+"move.php"),n.send(t)}(this.children[0].innerText)})}if("#chosen-card"===e||"#my-card"===e||"#your-pokedex-view-card"===e){let n=t.name?C(t.name):"";n&&($$(e+" h2.name").innerText=t.name+" ("+n+")")}for(;i<4;)o[i].classList.add("hidden"),i++}function k(){$("start-game").classList.contains("hidden")&&$("start-game").classList.remove("hidden");let e=this.getAttribute("pokemon");""!=e&&(q=e,getRequest(M+"pokedex.php","?pokemon="+e,function(e){let t=JSON.parse(e);v("chosen-card",t),v("my-card",t),v("your-pokedex-view-card",t)}))}function b(e,t){if(!t.error){let n=$(e);n.querySelector(".hp").innerText=t["current-hp"]+"HP",n.querySelector(".buffs").innerHTML="",function(e,t,n){for(let o=0;o<t.length+n.length;o++){let i=o<t.length?t[o]:n[o],s=document.createElement("div");s.className=o<t.length?"buff":"debuff",s.classList.add(i),e.appendChild(s)}}($$("#"+e+" .buffs"),t.buffs,t.debuffs);let o=1*t["current-hp"]/t.hp;if(n.querySelector(".health-bar").style.width=100*o+"%","my-card"==e)0==o?T(!1):o<=.2&&n.querySelector(".health-bar").classList.add("low-health");else if("their-card"==e)if(0==o){T(!0);t.images.photo;let e=t.name,n=$("my-pokemon").querySelector(".sprite[pokemon="+escSpChar(e)+"]");n&&n.classList.contains("unfound")&&function(e){let t="";confirm("You've collected "+e+"! Give it a nickname?")&&(t=prompt("Nickname to give your "+e+":"));let n="Calling insert.php with name="+e,o=new FormData;o.append("name",e),""!=t?(o.append("nickname",t),n+=" and nickname="+t):n+=" and no nickname";console.log(n),postRequest("insert.php",o,function(){let n=""!=t?t:e;alert("Success! You have added "+n+" to your Pokedex!"),r("pokedex-view",pid),r("my-pokemon",pid),r("my-dex-view",pid)})}(e)}else o<=.2&&n.querySelector(".health-bar").classList.add("low-health")}hide($("loading"))}function T(e){let t=$("my-card").querySelectorAll(".moves button");hide($("turn-status-p"));for(let e=0;e<t.length;e++)t[e].disabled=!0;$("title").innerHTML="You "+(e?"won!":"lost!"),show([$("results-container"),$("endgame")])}function x(){let e=P();e&&e.classList.remove(".current-view");let t=document.querySelectorAll(".sub-menu");for(let e=0;e<t.length;e++)hide(t[e])}function L(e,t){if(hide($$("#new-game-view .part-iii")),$(e).classList.contains("chosen-btn"))$(e).classList.remove("chosen-btn"),x();else{let n=document.querySelectorAll(".sub-menu"),o=document.querySelectorAll(".chosen-btn");for(let t=0;t<o.length;t++)o[t]!=e&&o[t].classList.remove("chosen-btn");if($(e).classList.add("chosen-btn"),$(t).classList.contains("hidden"))for(let e=0;e<n.length;e++)n[e]!=$(t)?(hide(n[e]),n[e].classList.remove("current-view")):(show(n[e]),n[e].classList.add("current-view"),"trade-view"===t&&(hide($("new-proposal-view")),hide($("current-proposals-view"))))}}function C(e){e=e.toLowerCase();let t=myPokemon.pokemon;for(let n=0;n<t.length;n++){let o=t[n].name.toLowerCase();if(o==e&&o.toUpperCase()!=t[n].nickname)return t[n].nickname}return null}function P(){return document.querySelector(".current-view")}let q="",S="",N="",M="https://webster.cs.washington.edu/pokedex-2/18sp/",_="https://webster.cs.washington.edu/pokedex/";window.onload=function(){fetchPid(),getRequest(M+"pokedex.php","?pokedex=all",g),getRequest(M+"list-users.php","",d),fetchMyPokemon(),$("your-pokedex-btn").onclick=function(){L(this.id,"your-pokedex-view"),r("my-dex-view",pid)},$$("#your-pokedex-view-card .name").ondblclick=t,n(),$("invite-btn").onclick=function(){s()},$("trade-btn").onclick=function(){L(this.id,"trade-view"),hide($("current-proposals-view")),hide($("new-proposal-view"))},$("propose").onclick=function(){this.classList.toggle("chosen-btn"),this.classList.contains("chosen-btn")&&$("view-proposals").classList.remove("chosen-btn"),hide($("current-proposals-view")),toggleDisplay($("new-proposal-view")),$("new-proposal-view").classList.contains("hidden")&&(show($("show-p2-dex")),hide($("pokedices")))},$("propose-submit").onclick=h,$("view-proposals").onclick=function(){toggleDisplay($("current-proposals-view")),this.classList.toggle("chosen-btn"),hide($("new-proposal-view")),this.classList.contains("chosen-btn")&&($("propose").classList.remove("chosen-btn"),a())},$("show-p2-dex").onclick=function(){show([$$("#new-proposal-view .part-iv"),$("pokedices")]),this.classList.add("hidden"),r("my-pokemon",pid),r("their-pokemon",$("users").value)},$("users").onchange=function(){r("my-pokemon",pid),r("their-pokemon",$("users").value)},i(),$("main-menu-btn").onclick=e,$("endgame").onclick=e,$("restart-btn").onclick=function(){confirm("Are you sure you want to remove all Pokemon from your Pokedex and start with three new random Pokemon?")&&getDex(pid,token,!0)},L("your-pokedex-btn","your-pokedex-view");let o=setInterval(function(){pid&&token&&myPokemon&&(clearInterval(o),r("my-dex-view",pid))},100)}}();
